/*
 Exercise 3 from Intro to OpenCV: write downsampled avi from camera to disk
 */

#include <opencv2/opencv.hpp>
#include <iostream>
#include <fstream>

using namespace std;
using namespace cv;

int main(int argc, char *argv[]) {
   if(argc < 2)
   {
      cout << "Oops. Please provide output filename" << endl;
      exit(1);
   }
   namedWindow("output",cv::WINDOW_AUTOSIZE);
   
   VideoCapture capture(0);
   double fps = capture.get(CV_CAP_PROP_FPS);
   
   cout << "fps from CAP_PROP_FPS:" << fps << endl;
   
   cv::Size size( (int)capture.get(CV_CAP_PROP_FRAME_WIDTH),
		  (int)capture.get(CV_CAP_PROP_FRAME_HEIGHT)
		  );
   int num_frames=120;
   Mat timerFrame;
   double startTix = getTickCount();
   double endTix;
   
   for (int kk=0; kk < num_frames; ++kk)
      capture >> timerFrame;
   endTix=getTickCount();
   double tixTaken=endTix - startTix;
   double calculatedFPS=num_frames / (tixTaken / getTickFrequency());
   cout << "Calculated FPS:" << calculatedFPS << endl;
   
   VideoWriter writer;
   writer.open(argv[1],CV_FOURCC('M','J','P','G'),calculatedFPS,size);
   Mat bgr_frame;
   char c;
   while(true) {
      capture >> bgr_frame;

      if(bgr_frame.empty())
	 break;
      imshow("output",bgr_frame);
      writer << bgr_frame;
      c = (char)waitKey(33);
      if(27 == c)
	 break;
   }
   capture.release();
   
   
		  
}
